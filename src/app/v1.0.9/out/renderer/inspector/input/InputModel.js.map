{"version":3,"file":"InputModel.js","sourceRoot":"","sources":["../../../../../front_end/input/InputModel.js"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as SDK from '../sdk/sdk.js';\n\nexport class InputModel extends SDK.SDKModel.SDKModel {\n  /**\n   * @param {!SDK.SDKModel.Target} target\n   */\n  constructor(target) {\n    super(target);\n    this._inputAgent = target.inputAgent();\n    /** @type {number} */\n    this._eventDispatchTimer = 0;\n    /** @type {!Array<!EventData>}*/\n    this._dispatchEventDataList = [];\n    /** @type {?function():void} */\n    this._finishCallback = null;\n    /** @type {number} */\n    this._dispatchingIndex;\n\n    this._reset();\n  }\n\n  _reset() {\n    /** @type {?number} */\n    this._lastEventTime = null;\n    /** @type {boolean} */\n    this._replayPaused = false;\n    /** @type {number} */\n    this._dispatchingIndex = 0;\n    window.clearTimeout(this._eventDispatchTimer);\n  }\n\n  /**\n   * @param {!SDK.TracingModel.TracingModel} tracingModel\n   */\n  setEvents(tracingModel) {\n    this._dispatchEventDataList = [];\n    for (const process of tracingModel.sortedProcesses()) {\n      for (const thread of process.sortedThreads()) {\n        this._processThreadEvents(tracingModel, thread);\n      }\n    }\n    /**\n     * @param {!EventData} a\n     * @param {!EventData} b\n     */\n    function compareTimestamp(a, b) {\n      return a.timestamp - b.timestamp;\n    }\n    this._dispatchEventDataList.sort(compareTimestamp);\n  }\n\n  /**\n   * @param {?function():void} finishCallback\n   */\n  startReplay(finishCallback) {\n    this._reset();\n    this._finishCallback = finishCallback;\n    if (this._dispatchEventDataList.length) {\n      this._dispatchNextEvent();\n    } else {\n      this._replayStopped();\n    }\n  }\n\n  pause() {\n    window.clearTimeout(this._eventDispatchTimer);\n    if (this._dispatchingIndex >= this._dispatchEventDataList.length) {\n      this._replayStopped();\n    } else {\n      this._replayPaused = true;\n    }\n  }\n\n  resume() {\n    this._replayPaused = false;\n    if (this._dispatchingIndex < this._dispatchEventDataList.length) {\n      this._dispatchNextEvent();\n    }\n  }\n\n  /**\n   * @param {!SDK.TracingModel.TracingModel} tracingModel\n   * @param {!SDK.TracingModel.Thread} thread\n   */\n  _processThreadEvents(tracingModel, thread) {\n    for (const event of thread.events()) {\n      if (event.name === 'EventDispatch' && this._isValidInputEvent(event.args.data)) {\n        this._dispatchEventDataList.push(event.args.data);\n      }\n    }\n  }\n\n\n  /**\n   * @param {!EventData} eventData\n   * @return {boolean}\n   */\n  _isValidInputEvent(eventData) {\n    return this._isMouseEvent(/** @type {!MouseEventData} */ (eventData)) ||\n        this._isKeyboardEvent(/** @type {!KeyboardEventData} */ (eventData));\n  }\n\n  /**\n   * @param {!MouseEventData} eventData\n   * @return {boolean}\n   */\n  _isMouseEvent(eventData) {\n    if (!MOUSE_EVENT_TYPE_TO_REQUEST_TYPE.has(eventData.type)) {\n      return false;\n    }\n    if (!('x' in eventData && 'y' in eventData)) {\n      return false;\n    }\n    return true;\n  }\n\n  /**\n   * @param {!KeyboardEventData} eventData\n   * @return {boolean}\n   */\n  _isKeyboardEvent(eventData) {\n    if (!KEYBOARD_EVENT_TYPE_TO_REQUEST_TYPE.has(eventData.type)) {\n      return false;\n    }\n    if (!('code' in eventData && 'key' in eventData)) {\n      return false;\n    }\n    return true;\n  }\n\n  _dispatchNextEvent() {\n    const eventData = this._dispatchEventDataList[this._dispatchingIndex];\n    this._lastEventTime = eventData.timestamp;\n    if (MOUSE_EVENT_TYPE_TO_REQUEST_TYPE.has(eventData.type)) {\n      this._dispatchMouseEvent(/** @type {!MouseEventData} */ (eventData));\n    } else if (KEYBOARD_EVENT_TYPE_TO_REQUEST_TYPE.has(eventData.type)) {\n      this._dispatchKeyEvent(/** @type {!KeyboardEventData} */ (eventData));\n    }\n\n    ++this._dispatchingIndex;\n    if (this._dispatchingIndex < this._dispatchEventDataList.length) {\n      const waitTime = (this._dispatchEventDataList[this._dispatchingIndex].timestamp - this._lastEventTime) / 1000;\n      this._eventDispatchTimer = window.setTimeout(this._dispatchNextEvent.bind(this), waitTime);\n    } else {\n      this._replayStopped();\n    }\n  }\n\n  /**\n   * @param {!MouseEventData} eventData\n   */\n  async _dispatchMouseEvent(eventData) {\n    const type = MOUSE_EVENT_TYPE_TO_REQUEST_TYPE.get(eventData.type);\n    if (!type) {\n      throw new Error(`Could not find mouse event type for eventData ${eventData.type}`);\n    }\n    const buttonActionName = BUTTONID_TO_ACTION_NAME.get(eventData.button);\n    const params = {\n      type,\n      x: eventData.x,\n      y: eventData.y,\n      modifiers: eventData.modifiers,\n      button: (eventData.type === 'mousedown' || eventData.type === 'mouseup') ? buttonActionName :\n                                                                                 Protocol.Input.MouseButton.None,\n      buttons: eventData.buttons,\n      clickCount: eventData.clickCount,\n      deltaX: eventData.deltaX,\n      deltaY: eventData.deltaY\n    };\n    await this._inputAgent.invoke_dispatchMouseEvent(params);\n  }\n\n  /**\n   * @param {!KeyboardEventData} eventData\n   */\n  async _dispatchKeyEvent(eventData) {\n    const type = KEYBOARD_EVENT_TYPE_TO_REQUEST_TYPE.get(eventData.type);\n    if (!type) {\n      throw new Error(`Could not find key event type for eventData ${eventData.type}`);\n    }\n    const text = eventData.type === 'keypress' ? eventData.key[0] : undefined;\n    const params = {\n      type,\n      modifiers: eventData.modifiers,\n      text: text,\n      unmodifiedText: text ? text.toLowerCase() : undefined,\n      code: eventData.code,\n      key: eventData.key\n    };\n    await this._inputAgent.invoke_dispatchKeyEvent(params);\n  }\n\n  _replayStopped() {\n    window.clearTimeout(this._eventDispatchTimer);\n    this._reset();\n    if (this._finishCallback) {\n      this._finishCallback();\n    }\n  }\n}\n\n/** @type {!Map<string, !Protocol.Input.DispatchMouseEventRequestType>} */\nconst MOUSE_EVENT_TYPE_TO_REQUEST_TYPE = new Map([\n  ['mousedown', Protocol.Input.DispatchMouseEventRequestType.MousePressed],\n  ['mouseup', Protocol.Input.DispatchMouseEventRequestType.MouseReleased],\n  ['mousemove', Protocol.Input.DispatchMouseEventRequestType.MouseMoved],\n  ['wheel', Protocol.Input.DispatchMouseEventRequestType.MouseWheel],\n]);\n\n/** @type {!Map<string, !Protocol.Input.DispatchKeyEventRequestType>} */\nconst KEYBOARD_EVENT_TYPE_TO_REQUEST_TYPE = new Map([\n  ['keydown', Protocol.Input.DispatchKeyEventRequestType.KeyDown],\n  ['keyup', Protocol.Input.DispatchKeyEventRequestType.KeyUp],\n  ['keypress', Protocol.Input.DispatchKeyEventRequestType.Char],\n]);\n\n/** @type {!Map<number, !Protocol.Input.MouseButton>} */\nconst BUTTONID_TO_ACTION_NAME = new Map([\n  [0, Protocol.Input.MouseButton.Left], [1, Protocol.Input.MouseButton.Middle], [2, Protocol.Input.MouseButton.Right],\n  [3, Protocol.Input.MouseButton.Back], [4, Protocol.Input.MouseButton.Forward]\n]);\n\nSDK.SDKModel.SDKModel.register(InputModel, SDK.SDKModel.Capability.Input, false);\n\n/** @typedef {{type: string, modifiers: number, timestamp: number, x: number, y: number, button: number, buttons: number, clickCount: number, deltaX: number, deltaY: number}} */\n// @ts-ignore typedef\nexport let MouseEventData;\n\n/** @typedef {{type: string, modifiers: number, timestamp: number, code: string, key: string}} */\n// @ts-ignore typedef\nexport let KeyboardEventData;\n\n/** @typedef {(!MouseEventData|!KeyboardEventData)} */\n// @ts-ignore typedef\nexport let EventData;\n"]}